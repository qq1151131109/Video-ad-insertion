"""
常见问题与故障排查

帮助用户快速解决使用过程中遇到的问题
"""

# 常见问题FAQ

## 安装与配置

### Q1: pip install时出现依赖冲突怎么办？
**A**: 建议使用虚拟环境隔离依赖：
```bash
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate  # Windows

pip install -r requirements.txt
```

### Q2: CUDA不可用，如何使用GPU？
**A**: 检查PyTorch是否正确安装CUDA版本：
```bash
python -c "import torch; print(torch.cuda.is_available())"
```

如果返回False，重新安装CUDA版PyTorch：
```bash
pip uninstall torch
pip install torch --index-url https://download.pytorch.org/whl/cu118
```

### Q3: 模型下载失败或速度很慢
**A**:
1. **Whisper模型**: 首次运行会自动下载到`~/.cache/whisper/`
   - 可以手动下载后放到该目录
   - 使用国内镜像或VPN

2. **Demucs模型**: 首次运行会自动下载
   - 约2GB，耐心等待
   - 检查网络连接

3. **MTCNN模型**: 自动下载，如果失败：
```bash
pip install mtcnn --upgrade
```

### Q4: ComfyUI连接失败
**A**: 检查以下几点：
1. ComfyUI服务是否运行：
```bash
curl http://103.231.86.148:9000
```

2. 检查防火墙设置
3. 检查.env配置：
```env
COMFYUI_HOST=103.231.86.148
COMFYUI_PORT=9000
COMFYUI_PROTOCOL=http
```

## 运行时错误

### Q5: 内存不足（OOM）错误
**症状**: `RuntimeError: CUDA out of memory` 或 `MemoryError`

**解决方案**:
1. 使用更小的AI模型：
```python
# 在pipeline.py中修改
self.asr_service = ASRService(model_name="base")  # 改为base
```

2. 减少GPU占用：
```bash
python main.py input/video.mp4 --device cpu  # 某些步骤用CPU
```

3. 处理更短的视频段
4. 增加系统交换空间（Linux）：
```bash
sudo fallocate -l 8G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### Q6: "视频文件不存在"错误
**症状**: `FileNotFoundError: 视频文件不存在`

**解决方案**:
1. 确认文件路径正确：
```bash
ls -la input/  # 检查文件是否存在
```

2. 使用绝对路径：
```bash
python main.py /full/path/to/video.mp4
```

3. 检查文件权限

### Q7: MoviePy编码错误
**症状**: `MoviePy Error: FFMPEG encountered the following error`

**解决方案**:
1. 确认ffmpeg已安装：
```bash
ffmpeg -version
```

2. 如未安装，安装ffmpeg：
```bash
# Ubuntu/Debian
sudo apt-get install ffmpeg

# macOS
brew install ffmpeg

# Windows
# 从 https://ffmpeg.org/download.html 下载并添加到PATH
```

3. 重新安装moviepy：
```bash
pip install moviepy --upgrade
```

### Q8: OpenAI API调用失败
**症状**: `OpenAI API Error` 或 `Authentication failed`

**解决方案**:
1. 检查API密钥是否正确：
```bash
grep OPENAI_API_KEY .env
```

2. 测试API连接：
```python
from openai import OpenAI
client = OpenAI(api_key="your_key", base_url="your_base_url")
response = client.chat.completions.create(
    model="gpt-4o-mini",
    messages=[{"role": "user", "content": "hi"}]
)
print(response)
```

3. 检查API额度和余额
4. 确认base_url正确

### Q9: Demucs人声分离失败
**症状**: `Demucs运行失败`

**解决方案**:
1. 确认Demucs已安装：
```bash
demucs --help
```

2. 如未安装：
```bash
pip install demucs
```

3. 测试Demucs：
```bash
demucs --two-stems vocals your_audio.wav
```

4. 如果GPU报错，使用CPU：
```python
separator.separate_simple(..., device="cpu")
```

### Q10: 人脸检测失败
**症状**: 未检测到人脸或检测错误

**解决方案**:
1. 降低置信度阈值：
```python
detector = FaceDetector(confidence_threshold=0.7)  # 从0.9降到0.7
```

2. 调整最小人脸尺寸：
```python
detector = FaceDetector(min_face_size=10)  # 从20降到10
```

3. 检查关键帧质量：
   - 确保人脸清晰
   - 光线充足
   - 角度适中

4. 尝试其他时间点的关键帧

## ComfyUI相关

### Q11: ComfyUI workflow执行超时
**症状**: `TimeoutError` 或 workflow长时间无响应

**解决方案**:
1. 增加超时时间：
```python
result = client.run_workflow_and_download(..., timeout=1200)  # 20分钟
```

2. 检查ComfyUI服务器状态
3. 减少并发请求
4. 优化workflow配置

### Q12: ComfyUI返回错误
**症状**: workflow执行失败，返回错误信息

**解决方案**:
1. 检查workflow JSON文件是否正确
2. 确认所需节点已安装在ComfyUI中
3. 检查输入参数是否匹配
4. 查看ComfyUI服务器日志

### Q13: 生成的图片/音频/视频质量不佳
**解决方案**:
1. 调整workflow参数（在JSON中）
2. 使用更高质量的输入
3. 尝试不同的workflow模板
4. 参考《质量评估指南.md》

## 性能问题

### Q14: 处理速度太慢
**参考**: 详见《性能优化指南.md》

**快速检查**:
1. 确认使用GPU：
```bash
nvidia-smi  # 查看GPU使用情况
```

2. 检查模型选择：
```python
# 使用更快的模型
ASRService(model_name="base")  # 而非medium
AudioSeparator(model="mdx_extra")  # 而非htdemucs
```

3. 监控资源使用：
```bash
htop  # 查看CPU和内存
```

### Q15: 磁盘空间不足
**症状**: `OSError: [Errno 28] No space left on device`

**解决方案**:
1. 清理缓存：
```bash
rm -rf cache/*
```

2. 清理输出目录：
```bash
rm -rf output/debug/*
```

3. 删除临时文件
4. 增加磁盘空间

## 输出质量问题

### Q16: 广告插入位置不合适
**解决方案**:
1. 调整LLM提示词（在`llm_service.py`中）
2. 增加候选插入点数量
3. 手动指定插入时间（修改代码）
4. 检查ASR识别准确度

### Q17: 广告词不自然
**解决方案**:
1. 优化广告配置（`config/ads.json`）:
   - 改进selling_points
   - 优化templates
   - 调整target_scenarios

2. 调整LLM temperature参数：
```python
# 在llm_service.py中
response = client.chat.completions.create(
    ...,
    temperature=0.9  # 增加创造性
)
```

3. 提供更详细的产品信息

### Q18: 数字人口型不同步
**解决方案**:
1. 改进人声分离质量
2. 使用更清晰的音频
3. 调整ComfyUI workflow参数
4. 尝试不同的声音情绪设置

### Q19: 视频拼接有明显痕迹
**解决方案**:
1. 确保原视频和广告视频参数一致
2. 使用更高质量的编码：
```python
# 在video_composer.py中
clip.write_videofile(
    ...,
    bitrate="8000k",  # 提高比特率
    preset="slow"  # 使用慢速高质量预设
)
```

3. 添加过渡效果（需修改代码）

## 日志和调试

### Q20: 如何查看详细日志？
**A**: 日志默认输出到控制台，也可保存到文件：

修改`src/utils/logger.py`：
```python
logger.add(
    "logs/debug_{time}.log",
    rotation="100 MB",
    retention="7 days",
    level="DEBUG"
)
```

### Q21: 如何调试特定模块？
**A**: 使用各个测试脚本：
```bash
# 测试ASR
python scripts/test_asr_llm.py

# 测试视频处理
python scripts/test_video_processor.py

# 测试ComfyUI
python scripts/test_workflows.py

# 测试视频合成
python scripts/test_video_composer.py
```

### Q22: 如何保留临时文件以供检查？
**A**: 修改配置：
```python
# 在.env中添加
KEEP_TEMP_FILES_ON_ERROR=True
```

或在代码中：
```python
file_mgr.cleanup(keep_on_error=True)
```

## 系统兼容性

### Q23: Windows上运行报错
**常见问题**:
1. 路径分隔符：使用`Path`对象而非字符串拼接
2. 文件编码：确保UTF-8编码
3. 权限问题：以管理员身份运行

### Q24: macOS上运行报错
**常见问题**:
1. M1/M2芯片：某些库可能需要特殊版本
2. ffmpeg路径：确保在PATH中
3. 权限问题：允许终端访问文件

### Q25: Docker容器中运行
**建议配置**:
```dockerfile
FROM python:3.9-slim

RUN apt-get update && apt-get install -y ffmpeg

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

CMD ["python", "main.py"]
```

注意：需要GPU支持需使用nvidia-docker

## 获取帮助

如果以上解决方案都无效，请：

1. **检查日志**: 查看完整错误信息
2. **收集信息**:
   - Python版本
   - 操作系统
   - GPU型号和驱动版本
   - 错误的完整堆栈跟踪
3. **提交Issue**: 在项目GitHub页面提交问题
4. **社区求助**: 查看是否有类似问题

## 错误代码参考

| 错误代码 | 含义 | 解决方案 |
|---------|------|---------|
| E001 | 视频文件不存在 | 检查文件路径 |
| E002 | 视频时长不符合要求 | 调整MIN/MAX_VIDEO_DURATION |
| E003 | ASR识别失败 | 检查Whisper安装和音频质量 |
| E004 | LLM API调用失败 | 检查API密钥和网络 |
| E005 | ComfyUI连接失败 | 检查服务状态和配置 |
| E006 | 视频合成失败 | 检查ffmpeg和MoviePy |
| E007 | GPU内存不足 | 使用较小模型或CPU |
| E008 | 人脸检测失败 | 调整参数或更换关键帧 |

## 最佳实践

1. **始终使用虚拟环境**
2. **定期清理缓存**
3. **监控资源使用**
4. **保持依赖更新**
5. **备份重要配置**
6. **使用版本控制**
7. **测试后再批量处理**
8. **保留处理日志**
