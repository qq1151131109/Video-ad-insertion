# 短视频智能插入广告项目流程速览

## 处理主流程（5 阶段）
1) 视频分析  
   - 提取视频元数据、分离音频、用 Demucs 做人声/伴奏分离。  
   - 代码：`src/core/video_processor.py`，`src/core/audio_separator.py`。
2) 内容理解  
   - Whisper ASR 获取带时间戳字幕；LLM 分析主题/类别并给出候选插入点。  
   - 代码：`src/core/asr.py`，`src/services/llm_service.py`。
3) 广告准备  
   - 提取插入点关键帧，MTCNN 人脸检测与质量评分，按 `config/ads.json` 选广告并让 LLM 生成场景化广告词。  
   - 代码：`src/core/face_detector.py`，`src/config/ads.py`。
4) 素材生成  
   - Qwen Image Edit 清洗关键帧；IndexTTS2 克隆原声并朗读广告词；InfiniteTalk 生成数字人视频。  
   - 代码：`src/services/image_cleaner.py`，`src/services/voice_clone.py`，`src/services/digital_human.py`。
5) 视频合成  
   - 在插入点切分原视频，插入数字人片段，做音频淡入淡出与混合，导出最终视频。  
   - 代码：`src/core/video_composer.py`，`src/core/pipeline.py`。

## 运行入口
```bash
python main.py input/video.mp4 [-o output_dir --device {cuda,cpu} --batch]
```
- 输出：`output/processed/<视频ID>/`
- CPU 模式：`--device cpu`
- 批量：`python main.py input/ --batch`

## 常用验证脚本
- 基础连通：`python scripts/test_comfyui.py`
- 视频处理：`python scripts/test_video_processor.py`
- 人声分离：`python scripts/test_audio_separator.py`
- ASR 与 LLM：`python scripts/test_asr_llm.py`
- 人脸检测：`python scripts/test_face_detector.py`
- Workflow 检查：`python scripts/test_workflows.py`
- 视频合成：`python scripts/test_video_composer.py`
- 端到端：`python scripts/test_end_to_end.py`

## 配置要点
- `.env` 提供 API 与 ComfyUI 连接信息（勿提交）。  
- 广告策略：`config/ads.json`。  
- 其他配置：`src/config/settings.py`。  
- 依赖：`requirements.txt`；建议使用虚拟环境。
