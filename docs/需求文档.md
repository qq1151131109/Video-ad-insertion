# 短视频智能插入算力广告需求文档

## 核心需求

### 关键要求
1. **每个视频只插入1个广告**（避免过度打扰用户）
2. **广告词必须基于视频文案上下文生成**（自然衔接，不突兀）
3. **使用数字人软广告**（保持原视频人物形象和声音风格）

---

## 技术实现方案

### 阶段0：视频预处理
- 提取视频元信息（分辨率、帧率、时长）
- 提取音频轨道

### 阶段1：语音识别 (ASR)
- 使用Whisper将视频音频转为带时间戳的文字
- 输出：完整文案 + 每个词/句的时间戳

### 阶段2：内容分析与插入点选择（基于文案）

#### 2.1 LLM内容分析
输入：完整文案
输出：
- 是否适合插入广告（布尔值）
- 适合的广告类型（NVIDIA算力）
- **3个候选插入点**（带时间戳、理由、优先级）

#### 2.2 插入点选择策略
- LLM分析文案找到**自然的句子间隔点或话题转折点**
- **只选择优先级最高的1个插入点**
- 避开视频开头3秒和结尾5秒
- 确保插入点前后有足够停顿

#### 2.3 上下文广告词生成（重点）
**输入**：
- 插入点前2-3句话（上文）
- 插入点后1-2句话（下文）
- 视频主题/类型

**处理**：
- LLM基于上下文生成15-20字的NVIDIA算力广告词
- 广告词需要：
  - 自然衔接上下文（语气、话题连贯）
  - 突出NVIDIA算力优势
  - 长度适中（对应3-5秒数字人视频）

**示例**：
```
原文案：
"...这个AI模型的训练速度非常快。【插入点】接下来我们看看它的效果如何..."

生成广告词：
"这得益于NVIDIA强大的算力支持，让AI训练事半功倍。"

最终效果：
"...这个AI模型的训练速度非常快。这得益于NVIDIA强大的算力支持，让AI训练事半功倍。接下来我们看看它的效果如何..."
```

### 阶段3：广告素材生成

#### 3.1 提取关键帧
- 提取插入点前1秒的视频帧（人物正脸）
- 多帧质量评估（清晰度、人脸完整性）

#### 3.2 图片清洗（ComfyUI - Qwen Image Edit）
- 输入：原始关键帧
- 提示词："去除字幕、水印、文字、标题"
- 输出：干净的人物图

#### 3.3 提取人声样本
- 从插入点前5-10秒提取人声
- 用于声音克隆的参考音频

#### 3.4 声音克隆（ComfyUI - IndexTTS2）
- 输入：
  - 参考音频（原视频人声）
  - 广告词文本
- 输出：克隆后的广告音频

#### 3.5 数字人视频生成（ComfyUI - InfiniteTalk）
- 输入：
  - 清洗后的人物图
  - 克隆后的广告音频
- 输出：数字人说话视频（3-5秒）

### 阶段4：视频合成

#### 4.1 视频切割
- 在插入点位置切割原视频
  - part1: 0s → 插入点
  - part2: 插入点 → 结束

#### 4.2 过渡效果处理
- **音频处理**：
  - part1最后0.5秒：音量渐弱
  - 广告音频：正常音量
  - part2开头0.5秒：音量渐强

- **视频处理**：
  - part1最后0.3秒：淡出效果（可选）
  - 广告视频：淡入+淡出效果
  - part2开头0.3秒：淡入效果（可选）

#### 4.3 后处理
- 色调统一（LUT调整，可选）
- 音量归一化
- 保持原视频分辨率、帧率

#### 4.4 视频拼接
- 按顺序拼接：part1 + 广告视频 + part2
- 输出：最终视频（H.264编码，MP4格式）

---

## 技术栈

### 已有工具（ComfyUI API）
- **图片清洗**: `docs/workflow/qwen_image_edit.json`
- **声音克隆**: `docs/workflow/index TTS2情绪控制_api_1013.json`
- **数字人生成**: `docs/workflow/InfiniteTalk数字人视频生视频_api.json`
- **ComfyUI地址**: `103.231.86.148:9000`

### 需要实现的模块
- **ASR服务**: OpenAI Whisper（本地）
- **LLM服务**: OpenAI API (gpt-4o-mini)
- **视频处理**: moviepy / ffmpeg-python
- **ComfyUI客户端**: 封装API调用

---

## 输入/输出规范

### 输入
- **原视频路径**: `input/` 目录
- **视频格式**: MP4（其他格式自动转换）
- **视频类型**: 文案为主的短视频（TikTok风格）

### 输出
- **输出路径**: `output/processed/`
- **视频格式**: MP4 (H.264)
- **分辨率**: 保持原视频分辨率
- **帧率**: 保持原视频帧率
- **音频**: AAC编码，保持音质

---

## 质量要求

### 广告词质量
- ✅ 自然衔接上下文（语义连贯）
- ✅ 长度适中（15-20字，对应3-5秒）
- ✅ 突出NVIDIA算力优势
- ✅ 语气与原视频保持一致

### 数字人视频质量
- ✅ 口型与音频同步
- ✅ 人物形象清晰
- ✅ 动作自然流畅

### 最终视频质量
- ✅ 过渡自然，无卡顿
- ✅ 音量一致，无突变
- ✅ 画面色调统一
- ✅ 广告插入不突兀

---

## 边界情况处理

### 不适合插入广告的情况
1. **视频时长 < 15秒**：太短，无合适插入点
2. **无人声或人声不清晰**：无法进行声音克隆
3. **无清晰人脸**：无法生成高质量数字人
4. **内容与算力无关且无法自然植入**：LLM判断不适合

**处理方式**：跳过处理，输出日志说明原因

---

## 后续优化方向（V2.0）

### 方案2：智能硬广插入（备选）
- 适用于非文案为主的视频（才艺、风景等）
- 基于场景切换检测找插入点
- 插入预制的算力广告视频

### 方案3：画中画/角标广告（备选）
- 适用于不适合打断的视频
- 在视频角落添加小窗口广告
- 不影响原视频播放

---

**文档版本**: v2.0
**最后更新**: 2025-11-14
**更新说明**: 补充核心需求（每视频1个广告、基于上下文生成广告词）